<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>X eller Y – med datum och veckodag</title>
  <style>
    body { 
      display: flex; 
      flex-direction: column;
      justify-content: center; 
      align-items: center; 
      height: 100vh; 
      font-family: Arial, sans-serif; 
      transition: background-color 0.5s ease;
    }
    .letter { 
      font-size: 15rem;
      font-weight: bold; 
      color: #fff;
    }
    .date, .weekday {
      font-size: 4rem;
      font-weight: bold;
      margin-top: 0.5rem;
      color: #fff;
    }
  </style>
</head>
<body>
  <div class="letter" id="letter">...</div>
  <div class="date" id="date">...</div>
  <div class="weekday" id="weekday">...</div>

  <script>
    const startDate = new Date("2025-01-02");
    let holidays = [];

    async function fetchHolidays(year) {
      const url = `https://api.dagsmart.se/holidays?year=${year}&weekends=false`;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error("Fel vid hämtning av helgdagar");
        const data = await res.json();
        return data.map(h => h.date);
      } catch (err) {
        console.error(err);
        return [];
      }
    }

    function isValidWorkday(date) {
      const day = date.getDay();
      const str = date.toISOString().split("T")[0];
      return (day !== 0 && day !== 6 && !holidays.includes(str));
    }

    function countWorkdays(from, to) {
      let count = 0;
      const cur = new Date(from);
      while (cur <= to) {
        if (isValidWorkday(cur)) count++;
        cur.setDate(cur.getDate() + 1);
      }
      return count;
    }

    async function displayLetter() {
      let today = new Date();
      const switchHour = 5;
      const switchMinute = 25;

      if (today.getHours() < switchHour || (today.getHours() === switchHour && today.getMinutes() < switchMinute)) {
        today.setDate(today.getDate() - 1);
      }

      const thisYear = today.getFullYear();
      const nextYear = thisYear + 1;

      if (holidays.length === 0) {
        const [h1, h2] = await Promise.all([fetchHolidays(thisYear), fetchHolidays(nextYear)]);
        holidays = [...h1, ...h2];
      }

      let refDate = today;
      if (!isValidWorkday(today)) {
        refDate = new Date(today);
        while (!isValidWorkday(refDate) && refDate >= startDate) {
          refDate.setDate(refDate.getDate() - 1);
        }
      }

      const count = countWorkdays(startDate, refDate);
      const letter = (count % 2 === 0) ? "Y" : "X";

      document.getElementById("letter").textContent = letter;

      const yyyy = refDate.getFullYear();
      const mm = String(refDate.getMonth() + 1).padStart(2, "0");
      const dd = String(refDate.getDate()).padStart(2, "0");
      document.getElementById("date").textContent = `${yyyy}-${mm}-${dd}`;

      let dayName = refDate.toLocaleDateString('sv-SE', { weekday: 'long' });
      dayName = dayName.charAt(0).toUpperCase() + dayName.slice(1);
      document.getElementById("weekday").textContent = dayName;

      document.body.style.backgroundColor = (letter === "X") ? "#0BA2F4" : "#27F584";
    }

    displayLetter();

    function scheduleNextUpdate() {
      const now = new Date();
      const next = new Date();
      next.setHours(5, 25, 0, 0);
      if (now >= next) next.setDate(next.getDate() + 1);

      const msUntilNext = next - now;
      setTimeout(() => {
        displayLetter();
        scheduleNextUpdate();
      }, msUntilNext);
    }

    scheduleNextUpdate();
  </script>
</body>
</html>
